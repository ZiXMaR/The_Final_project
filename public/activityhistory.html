<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>บันทึกประวัติกิจกรรม</title>
    <link rel="stylesheet" href="styles.css"> <!-- ลิงก์ไปยังไฟล์ CSS -->
</head>
<body>
    <div class="container">
        <h1>บันทึกประวัติกิจกรรม</h1>

        <!-- ฟอร์มสำหรับบันทึกกิจกรรมใหม่ -->
        <form id="activityForm">
            
            <input type="hidden" id="activityId"> <!-- เพิ่มส่วนนี้เพื่อเก็บ activity_id -->

            <div class="form-group">
                <label for="userId">รหัสผู้ใช้:</label>
                <input type="text" id="userId" required>
            </div>

            <div class="form-group">
                <label for="activityName">ชื่อกิจกรรม:</label>
                <input type="text" id="activityName" required>
            </div>

            <div class="form-group">
                <label for="activityDate">วันที่เข้าร่วม:</label>
                <input type="datetime-local" id="activityDate" required>
            </div>

            <div class="form-group">
                <label for="isPromoted">กิจกรรมที่โปรโมต:</label>
                <select id="isPromoted">
                    <option value="1">ใช่</option>
                    <option value="0">ไม่</option>
                </select>
            </div>

            <div class="form-group">
                <label for="competencyHours">จำนวนชั่วโมงกิจกรรมเสริมสร้างสมรรถนะ:</label>
                <input type="number" id="competencyHours" required>
            </div>

            <div class="form-group">
                <label for="interestHours">จำนวนชั่วโมงกิจกรรมตามความสนใจ:</label>
                <input type="number" id="interestHours" required>
            </div>

            <!-- ปุ่มสำหรับบันทึกและแก้ไขกิจกรรม -->
            <button type="button" id="saveButton">บันทึกกิจกรรม</button>
            <button type="button" id="editButton" style="display: none;">แก้ไขกิจกรรม</button>
        </form>

        <h2>ประวัติกิจกรรมที่เข้าร่วม</h2>
        <table id="activityTable">
            <thead>
                <tr>
                    <th>ชื่อกิจกรรม</th>
                    <th>วันที่เข้าร่วม</th>
                    <th>กิจกรรมที่โปรโมต</th>
                    <th>ชั่วโมงกิจกรรมเสริมสร้างสมรรถนะ</th>
                    <th>ชั่วโมงกิจกรรมตามความสนใจ</th>
                    <th>แก้ไข</th>
                    <th>ลบ</th>
                </tr>
            </thead>
            <tbody>
                <!-- รายการกิจกรรมที่เข้าร่วมจะถูกเพิ่มที่นี่ -->
            </tbody>
        </table>
    </div>

    <script>
        // ฟังก์ชันสำหรับบันทึกกิจกรรมใหม่
        document.getElementById('saveButton').addEventListener('click', function(event) {
            event.preventDefault(); // ป้องกันการรีเฟรชหน้า
    
            const activityData = {
                user_id: document.getElementById('userId').value,
                activity_name: document.getElementById('activityName').value,
                activity_date: document.getElementById('activityDate').value,
                is_promoted: document.getElementById('isPromoted').value,
                competency_hours: document.getElementById('competencyHours').value,
                interest_hours: document.getElementById('interestHours').value
            };

            fetch('/record-activityhistory', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(activityData)
            })
            .then(response => {
                if (response.ok) {
                    alert('บันทึกกิจกรรมสำเร็จ');
                    loadActivities(); // โหลดรายการกิจกรรมอีกครั้งหลังบันทึก
                    clearForm(); // ล้างฟอร์มหลังบันทึก
                } else {
                    return response.text().then(text => {
                        alert(`เกิดข้อผิดพลาด: ${text}`);
                    });
                }
            });
        });

        // ฟังก์ชันสำหรับแก้ไขกิจกรรม
        document.getElementById('editButton').addEventListener('click', function(event) {
            event.preventDefault(); // ป้องกันการรีเฟรชหน้า

            const updatedActivityData = {
                user_id: document.getElementById('userId').value,
                activity_name: document.getElementById('activityName').value,
                activity_date: document.getElementById('activityDate').value,
                is_promoted: document.getElementById('isPromoted').value,
                competency_hours: document.getElementById('competencyHours').value,
                interest_hours: document.getElementById('interestHours').value,
                activity_id: document.getElementById('activityId').value
            };

            fetch('/update-activityhistory', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(updatedActivityData)
            })
            .then(response => {
                if (response.ok) {
                    alert('แก้ไขกิจกรรมสำเร็จ');
                    loadActivities(); // โหลดรายการกิจกรรมอีกครั้งหลังแก้ไข
                    clearForm(); // ล้างฟอร์มหลังแก้ไข
                } else {
                    alert('เกิดข้อผิดพลาดในการแก้ไขกิจกรรม');
                }
            });
        });

        // ฟังก์ชันสำหรับโหลดกิจกรรมที่เข้าร่วม
        function loadActivities() {
            fetch('/get-activityhistory')
                .then(response => response.json())
                .then(data => {
                    const tableBody = document.getElementById('activityTable').getElementsByTagName('tbody')[0];
                    tableBody.innerHTML = ''; // เคลียร์เนื้อหาเก่า

                    data.forEach(activity => {
                        const row = tableBody.insertRow();
                        row.insertCell(0).innerText = activity.activity_name;
                        row.insertCell(1).innerText = new Date(activity.activity_date).toLocaleString();
                        row.insertCell(2).innerText = activity.is_promoted ? 'ใช่' : 'ไม่';
                        row.insertCell(3).innerText = activity.competency_hours || 0;
                        row.insertCell(4).innerText = activity.interest_hours || 0;

                        const editButton = document.createElement('button');
                        editButton.innerText = 'แก้ไข';
                        editButton.onclick = () => editActivity(activity); // เรียกฟังก์ชันแก้ไข
                        row.insertCell(5).appendChild(editButton);

                        const deleteButton = document.createElement('button');
                        deleteButton.innerText = 'ลบ';
                        deleteButton.onclick = () => deleteActivity(activity.activity_id); // เรียกฟังก์ชันลบ
                        row.insertCell(6).appendChild(deleteButton);
                    });
                });
        }

        function editActivity(activity) {
            document.getElementById('userId').value = activity.user_id;
            document.getElementById('activityName').value = activity.activity_name;
            document.getElementById('activityDate').value = new Date(activity.activity_date).toISOString().slice(0, 16);
            document.getElementById('isPromoted').value = activity.is_promoted;
            document.getElementById('competencyHours').value = activity.competency_hours;
            document.getElementById('interestHours').value = activity.interest_hours;
            document.getElementById('activityId').value = activity.activity_id;

            document.getElementById('saveButton').style.display = 'none'; // ซ่อนปุ่มบันทึก
            document.getElementById('editButton').style.display = 'inline'; // แสดงปุ่มแก้ไข
        }

        function clearForm() {
            document.getElementById('userId').value = '';
            document.getElementById('activityName').value = '';
            document.getElementById('activityDate').value = '';
            document.getElementById('isPromoted').value = '0';
            document.getElementById('competencyHours').value = '';
            document.getElementById('interestHours').value = '';
            document.getElementById('activityId').value = '';

            document.getElementById('saveButton').style.display = 'inline'; // แสดงปุ่มบันทึก
            document.getElementById('editButton').style.display = 'none'; // ซ่อนปุ่มแก้ไข
        }

        // ฟังก์ชันสำหรับลบกิจกรรม
        function deleteActivity(activityId) {
            if (confirm('คุณแน่ใจหรือไม่ว่าต้องการลบกิจกรรมนี้?')) {
                fetch(`/delete-activityhistory/${activityId}`, {
                    method: 'DELETE'
                })
                .then(response => {
                    if (response.ok) {
                        alert('ลบกิจกรรมสำเร็จ');
                        loadActivities(); // โหลดรายการกิจกรรมอีกครั้งหลังลบ
                    } else {
                        alert('เกิดข้อผิดพลาดในการลบกิจกรรม');
                    }
                });
            }
        }

        // โหลดกิจกรรมเมื่อหน้าเว็บถูกเปิดครั้งแรก
        window.onload = loadActivities;
    </script>
</body>
</html>
